通過在線下環境压力測試，發現幾個問題：

1,事務操作原子性沒有保證
2,存在超賣

原因說明：

操作事務有一個需要注意的地方，事務中的數據庫操作一定不要有連接中斷重連機制，這樣會导致事務失效，破壞了原子性。

存在超賣的原因比較復雜。主要還是環境的問題：

目前扣減庫存需要操作兩張表 log + sku，這兩張表通過事務更新。線下環境並發量一大，就會出現網絡不稳定的現象，數據庫操作已經成功，但是commit返回失敗。
那麼如果加上判断commit的返回值，是不是要好一些？有如下問題

PDO的commit結果不可信(有人反饋是一個bug，驗證過，的確不可信)，mysqli->commit通過測試看是正確的，但不排除出錯的可能。

一般情況下，沒有看到驗證commit的必要性。

在不驗證commit返回結果的前提下，有可能commit執行失敗，事務回滚。但是網絡原因並不會抛出异常。訂單以爲扣減庫存成功，造成超賣。

所以建議先扣減庫存，再去生成訂單。原因是

1,若生成订单，再去扣减库存。库存扣减失败后，需要更新订单表（成功后也要更新），增加了DB操作次数，增加数据出错的概率。
2,可以先扣減庫存，只有成功後，才去真正的把訂單寫到數據表。訂單號可以通過生成器來生成。

即使先扣減庫存，由於網絡原因，也有可能給出錯語的信息。 有兩種應對方案
一種是接受這樣極端情況下的异常。（應該是極爲少見）
二是事務操作成功後，再去log表查詢一次（主庫查詢），只有真正的寫入到數據庫，才通知訂單扣減庫存成功。

